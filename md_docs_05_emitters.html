<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="Snowplow C++ Tracker" />
<meta property="og:description" content="Snowplow event tracker for C++. Add analytics to your C++ applications, games and servers" />
<meta property="og:url" content="https://github.com/snowplow/snowplow-cpp-tracker" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:title" content="Snowplow C++ Tracker" />
<meta name="twitter:description" content="Snowplow event tracker for C++. Add analytics to your C++ applications, games and servers" />
<!-- END twitter metadata -->
<title>Snowplow C++ Tracker: Emitters</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/snowplow/snowplow-cpp-tracker" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Snowplow C++ Tracker
   &#160;<span id="projectnumber">0.4.0-1-g8e96411</span>
   </div>
   <div id="projectbrief">Snowplow event tracker for C++. Add analytics to your C++ applications, games and servers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_05_emitters.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Emitters </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The Tracker instance must be initialized with an emitter. This section will go into more depth about the Emitter and how it works under the hood.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> storage = std::make_shared&lt;SqliteStorage&gt;(<span class="stringliteral">&quot;sp.db&quot;</span>); <span class="comment">// or custom EventStore</span></div>
<div class="line">Emitter emitter(<span class="stringliteral">&quot;com.acme&quot;</span>, Emitter::Method::POST, Emitter::Protocol::HTTP, 52000, 52000, 500, storage);</div>
</div><!-- fragment --><p >There are other optional arguments:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><b>Argument Name</b>   </th><th class="markdownTableHeadNone"><b>Description</b>   </th><th class="markdownTableHeadNone"><b>Required?</b>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>uri</code>   </td><td class="markdownTableBodyNone">The URI to send events to   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>method</code>   </td><td class="markdownTableBodyNone">The request type to use (GET or POST)   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>protocol</code>   </td><td class="markdownTableBodyNone">The protocol to use (http or https)   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>batch_size</code>   </td><td class="markdownTableBodyNone">The maximum amount of events to send at a time   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>byte_limit_post</code>   </td><td class="markdownTableBodyNone">The byte limit when sending a POST request   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>byte_limit_get</code>   </td><td class="markdownTableBodyNone">The byte limit when sending a GET request   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>event_store</code>   </td><td class="markdownTableBodyNone">Implementation of the <code>EventStore</code> struct to persist an event queue with events to send   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>http_client</code>   </td><td class="markdownTableBodyNone">Unique pointer to a custom HTTP client to send GET and POST requests with   </td><td class="markdownTableBodyNone">No   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md33"></a>
Event store</h1>
<p >The event store is used to store an event queue with events scheduled to be sent. Events are added to the event store when they are tracked and removed when they are successfuly emitted or when emitting fails without any scheduled retries.</p>
<p >The tracker provides the <code>SqliteStorage</code> class that can be used as the event store. It uses SQLite to store the event queue. By default it will create the required files wherever the application is being run from.</p>
<p >You may also provide a custom event store implementation. To do so, define a class that inherits from the <code>EventStore</code> struct:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>EventStore {</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> add_event(<span class="keyword">const</span> Payload &amp;payload) = 0;</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> get_event_rows_batch(list&lt;EventRow&gt; *event_list, <span class="keywordtype">int</span> number_to_get) = 0;</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> delete_event_rows_with_ids(<span class="keyword">const</span> list&lt;int&gt; &amp;id_list) = 0;</div>
<div class="line">};</div>
</div><!-- fragment --><p >The <code>EventStore</code> struct defines functions to insert, retrieve, and remove events from the queue. Events are represented using their <code>Payload</code> instance which is persisted in a <code>EventRow</code> wrapper that also assigns IDs to each stored event (these event row IDs are different from event IDs used in the event payloads). There are three supported operations:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Function   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>add_event</code>   </td><td class="markdownTableBodyNone">Insert event payload into event queue.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>get_event_rows_batch</code>   </td><td class="markdownTableBodyNone">Retrieve event rows from event queue up to the given limit.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>delete_event_rows_with_ids</code>   </td><td class="markdownTableBodyNone">Remove event rows with the given event row IDs.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md34"></a>
Emitter request callback</h1>
<p >The Emitter enables you to set a callback function to be called after events are attempted to be sent to the Collector. This callback is fired after HTTP requests are made and you can subscribe for specific emit statuses. The following statuses can be subscribed to:</p>
<ul>
<li><code>EmitStatus::SUCCESS</code> – events were successfuly sent to the Collector.</li>
<li><code>EmitStatus::FAILED_WILL_RETRY</code> – events failed to be sent to the Collector but will be retried later.</li>
<li><code>EmitStatus::FAILED_WONT_RETRY</code> – events failed to be sent to the Collector and won't be retried later (they will be dropped).</li>
</ul>
<p >The callback is given two arguments – list of event IDs, and their emit status. You can only set one callback at once but you can subscribe to multiple emit statuses using binary operations. The following example shows how to set a callback that is called for all three emit statuses and prints to standard output.</p>
<div class="fragment"><div class="line">emitter.set_request_callback(</div>
<div class="line">    [](list&lt;string&gt; event_ids, <a class="code hl_enumeration" href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665c">EmitStatus</a> emit_status) {</div>
<div class="line">      <span class="keywordflow">switch</span> (emit_status) {</div>
<div class="line">      <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665caa96569c68a37a0fe1b69da5cba91553f">EmitStatus::SUCCESS</a>:</div>
<div class="line">        printf(<span class="stringliteral">&quot;Successfuly sent %lu events.\n&quot;</span>, event_ids.size());</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665ca8fb915a66f014ddc7ea5bdd006100191">EmitStatus::FAILED_WILL_RETRY</a>:</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to send %lu events, but will retry.\n&quot;</span>, event_ids.size());</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665ca463bfc4cbb4be572e169e6ff6dc06f16">EmitStatus::FAILED_WONT_RETRY</a>:</div>
<div class="line">        printf(<span class="stringliteral">&quot;Failed to send %lu events and won&#39;t retry.\n&quot;</span>, event_ids.size());</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    },</div>
<div class="line">    <a class="code hl_enumvalue" href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665caa96569c68a37a0fe1b69da5cba91553f">EmitStatus::SUCCESS</a> | <a class="code hl_enumvalue" href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665ca8fb915a66f014ddc7ea5bdd006100191">EmitStatus::FAILED_WILL_RETRY</a> | <a class="code hl_enumvalue" href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665ca463bfc4cbb4be572e169e6ff6dc06f16">EmitStatus::FAILED_WONT_RETRY</a>);</div>
<div class="ttc" id="anamespacesnowplow_html_af3c8b5883849b0dbae48dfd0707f665c"><div class="ttname"><a href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665c">snowplow::EmitStatus</a></div><div class="ttdeci">EmitStatus</div><div class="ttdef"><b>Definition:</b> emitter.hpp:43</div></div>
<div class="ttc" id="anamespacesnowplow_html_af3c8b5883849b0dbae48dfd0707f665ca463bfc4cbb4be572e169e6ff6dc06f16"><div class="ttname"><a href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665ca463bfc4cbb4be572e169e6ff6dc06f16">snowplow::FAILED_WONT_RETRY</a></div><div class="ttdeci">@ FAILED_WONT_RETRY</div><div class="ttdef"><b>Definition:</b> emitter.hpp:46</div></div>
<div class="ttc" id="anamespacesnowplow_html_af3c8b5883849b0dbae48dfd0707f665ca8fb915a66f014ddc7ea5bdd006100191"><div class="ttname"><a href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665ca8fb915a66f014ddc7ea5bdd006100191">snowplow::FAILED_WILL_RETRY</a></div><div class="ttdeci">@ FAILED_WILL_RETRY</div><div class="ttdef"><b>Definition:</b> emitter.hpp:45</div></div>
<div class="ttc" id="anamespacesnowplow_html_af3c8b5883849b0dbae48dfd0707f665caa96569c68a37a0fe1b69da5cba91553f"><div class="ttname"><a href="namespacesnowplow.html#af3c8b5883849b0dbae48dfd0707f665caa96569c68a37a0fe1b69da5cba91553f">snowplow::SUCCESS</a></div><div class="ttdeci">@ SUCCESS</div><div class="ttdef"><b>Definition:</b> emitter.hpp:44</div></div>
</div><!-- fragment --><p >The callback is executed in a new thread. The <code>set_request_callback</code> function can't be called when the Emitter is running.</p>
<h1><a class="anchor" id="autotoc_md35"></a>
Under the hood</h1>
<p >Once the emitter receives an event from the Tracker a few things start to happen:</p>
<ul>
<li>The event is added to a local Sqlite3 database (blocking execution)</li>
<li>A long running daemon thread is started which will continue to send events as long as they can be found in the database (asynchronous)</li>
<li>The emitter loop will grab a range of events from the database up until the <code>SendLimit</code> as noted __above_</li>
<li>The emitter will send all of these events as determined by the Request, Protocol and ByteLimits<ul>
<li>Each request is sent in its thread.</li>
</ul>
</li>
<li>Once sent it will process the results of all the requests sent and will remove all successfully sent events from the database</li>
</ul>
<h1><a class="anchor" id="autotoc_md36"></a>
HTTP request retry behavior</h1>
<p >The Emitter has a retry functionality that repeatedly sends the same events to the Collector in case HTTP requests fail to get through. Requests are retried in case the connection to the Collector fails to be estabilished. They are also retried for all 3xx and 5xx HTTP status codes in server response and most 4xx status codes with the following exceptions – 400, 401, 403, 410, and 422. These status codes signal a rejection of the events being sent to the Collector and, therefore, the events in the requests are dropped and not sent again.</p>
<p >The Emitter provides an option to set custom retry behavior for 3xx, 4xx and 5xx HTTP status codes. You can call the <code>set_retry_for_status_code</code> function on the Emitter instance to define whether to retry or not for a given HTTP status code. Here is an example that overrides the default behavior and enables retries on 422 status code:</p>
<div class="fragment"><div class="line">emitter.set_retry_for_status_code(422, <span class="keyword">true</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md37"></a>
Request retry delay (back-off)</h1>
<p >Failed requests are retried with exponentially increasing delays between subsequent retry requests. This ensures that the Collector is not overwhelmed with too many requests and also saves resources on the client by reducing the number of requests during failures.</p>
<p >The retry delay calculation is an exponential function with multiplicative factor 2. To prevent spikes of traffic, small amount of randomness is added to the delay (at most 10% of the total value). Finally, it is limited to be no larger than around 2 minutes. The following is a sample sequence of the retry delays given 5 failed requests: 0.101s, 0.198s, 0.404s, 0.791s, 1.603s.</p>
<h1><a class="anchor" id="autotoc_md38"></a>
Manual flushing</h1>
<p >You may want to force an emitter to send all events in its buffer, even if the buffer is not full. The Tracker class has a <code>flush()</code> method which flushes its emitter.</p>
<p >Example:</p>
<div class="fragment"><div class="line">tracker-&gt;flush();</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md39"></a>
Using a custom HTTP Client</h1>
<p >You may optionally configure the HTTP client to be used to make HTTP requests to the collector. This is done by passing a unique pointer to a class inheriting from <code>HttpClient</code> that the Emitter will take ownership of. If not configured, the Emitter will use the built-in <code>HttpClientWindows</code> on Windows, <code>HttpClientApple</code> on Apple operating systems, and <code>HttpClientCurl</code> on other Unix systems. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
